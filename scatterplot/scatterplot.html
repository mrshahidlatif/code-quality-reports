<!DOCTYPE html>
<html>
<meta charset="utf-8">
<script src="lib/jquery-2.2.2.min.js"></script>
<script src="lib/d3.v4.min.js"></script>
<script src="lib/d3-scale-chromatic.v1.min.js"></script>
<script src="lib/bboxCollide.js"></script>
<script src="lib/d3-annotation.js"></script>

<style>
    body {
		font-family: calibri;
		margin: 0px;
        padding: 0px;
        width: 280px;
        height: 280px;
        
	}

    .axis {
		font: 12px calibri;
	}

    .label {
		font: 16px calibri;
	}

    .tooltip {
        position: absolute;
        max-width: 250px;
        max-height: 64px;
        padding: 4px;
        background: #f2f2f2;
        pointer-events: none;
    }

    .annotation-note {
        cursor: pointer;
    }

    .text-center {
        text-align: center;
        margin: 5px;
        height: 10px;
        width: 280px;
       
    }
    #controls{
        z-index: 10;
        text-align: center;
        margin: 5px;
        height: 30px;
        width: 280px;
    }

    #chart_container {
        width: 280px;
        height: 280px;
        position: relative;
		margin: 0px;
    }

    #chart {
        width: 280px;
        height: 280px;
		position: absolute;
    }

</style>

<body>

<div id="controls" >
</div>

<div id="chart_container">
    <div id="chart"></div>
    <div id="tooltip" class="tooltip"></div>
</div>

<script type="text/javascript" src="src/scatter_harris.js"></script>
<script type="text/javascript">

    function clone(obj) {
        if (obj === null || typeof(obj) !== 'object' || 'isActiveClone' in obj)
            return obj;

        if (obj instanceof Date)
            var temp = new obj.constructor(); //or new Date(obj);
        else
            var temp = obj.constructor();

        for (var key in obj) {
            if (Object.prototype.hasOwnProperty.call(obj, key)) {
                obj['isActiveClone'] = null;
                temp[key] = clone(obj[key]);
                delete obj['isActiveClone'];
            }
        }

        return temp;
    }

    function load_d3(fileHandler) {
       d3.csv(fileHandler, function(data) {
			prev_data = clone(data);

            selectData = [];
            for(var c in data.columns) {
                if(excluded_keys.indexOf(data.columns[c]) == -1) {
                    selectData.push({text: data.columns[c]});
                }
            }

            window.parent._chartdata = clone(data);
			window.parent.generateReport();

            setup(data);
        });
    }

	window.parent._scatterplot = load_d3;

    var OUTLIER_THRESHOLD = 15, selectData = [], prev_data, excluded_keys = ["cname"], prev_options = {}, dimensions = [];

    function xChange(){
        prev_options.xSelect = this.value;
        if(prev_data) {
            var chart_data = clone(prev_data);
            setup(chart_data);
        }
    }

    function yChange(){
        prev_options.ySelect = this.value;
        if(prev_data) {
            var chart_data = clone(prev_data);
            setup(chart_data);
        }
    }

    var root = d3.select('#controls');
    var tooltip = d3.select('#tooltip').style("opacity", 0);

    function updateThreshold(){
        const thresh = OUTLIER_THRESHOLD;
        try {OUTLIER_THRESHOLD = parseInt(document.getElementById("outlierInput").value);} catch(e){}
        if(thresh != OUTLIER_THRESHOLD) {
            var chart_data = clone(prev_data);
            setup(chart_data);
        }
    }

    function setup(data){
        try {OUTLIER_THRESHOLD = parseInt(document.getElementById("outlierInput").value);} catch(e){}

        d3.selectAll('#controls>*').remove();

        var xSpan = root.append('span')
            .text('X-axis Metric: ');

        var xInput = root.append('select')
            .attr('id','xSelect')
            .on('change', xChange)
            .selectAll('option')
            .data(selectData)
            .enter()
            .append('option')
            .attr('value', function (d) { return d.text })
            .text(function (d) { return d.text ;});

        root.append('br');

        var ySpan = root.append('span')
            .text('Y-Axis Metric: ')

        var yInput = root.append('select')
            .attr('id','ySelect')
            .on('change',yChange)
            .selectAll('option')
            .data(selectData)
            .enter()
            .append('option')
            .attr('value', function (d) { return d.text })
            .text(function (d) { return d.text ;});

        root.append('br');
        root.append('br');

        dimensions = [];
        d3.keys(data[0]).map(function(item){
            try {if(item != "cname" && !isNaN(parseFloat(data[0][item]))) {
                dimensions.push(item);
            }} catch(e){}
        });

        var dims = {};
        var dimension = [dimensions[0], dimensions[0]];
        try {if(prev_options.xSelect != null) {
            document.getElementById("xSelect").value = prev_options.xSelect;
            dimension[0] = prev_options.xSelect;
            dims[dimension[0]] = [null, 0];
        }} catch(e){}
        try {if(prev_options.ySelect != null) {
            document.getElementById("ySelect").value = prev_options.ySelect;
            dimension[1] = prev_options.ySelect;
            dims[dimension[1]] = [null, 0];
        }} catch(e){}
        

        d3.selectAll("#chart>*").remove();
        var scatterplot = ScatterPlot().$el("#chart").size(215).threshold(12).margin(35).threshold(OUTLIER_THRESHOLD)
            .dotRadius(4).dotOpacity(1).dimensions(dimension).data(data).mouseover(function(d, i){
                tooltip.style("opacity", 1)
                    .html((d.cname ? d.cname.split(".").pop() : ("label" + d.index.toString())))
                    .style("left", (d3.event.pageX - 155) + "px")  // specify x location
                    .style("top", (d3.event.pageY - 110) + "px");  // specify y location
            }).mouseout(function(d){
                tooltip.style("opacity", 0);
            });
        scatterplot.render();

    }

  function scatterfilter(newdata){
		var g = d3.select("#chart svg g");
		g.selectAll(".dot")
			.style("fill", function(d,i) { return newdata[i]? "red": "steelblue";} );

	}

	window.parent._scatterfilter = scatterfilter;
</script>
</body>
</html>
